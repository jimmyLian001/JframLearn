<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baofu.international.global.account.core.dal.mapper.UserWithdrawOrderMapper">
    <resultMap id="BaseResultMap" type="com.baofu.international.global.account.core.dal.model.UserWithdrawOrderDo">
        <id column="ID" jdbcType="BIGINT" property="id"/>
        <result column="USER_NO"        jdbcType="BIGINT" property="userNo"/>
        <result column="USER_TRANS_ID"  jdbcType="VARCHAR" property="userTransId"/>
        <result column="ORDER_ID"       jdbcType="BIGINT" property="orderId"/>
        <result column="TRADE_AT"       jdbcType="TIMESTAMP" property="tradeAt"/>
        <result column="ORDER_AMT"      jdbcType="DECIMAL" property="orderAmt"/>
        <result column="ORDER_CCY"      jdbcType="CHAR" property="orderCcy"/>
        <result column="PAYEE_ID_TYPE"  jdbcType="TINYINT" property="payeeIdType"/>
        <result column="PAYEE_ID_NO"    jdbcType="VARCHAR" property="payeeIdNo"/>
        <result column="PAYEE_NAME"     jdbcType="VARCHAR" property="payeeName"/>
        <result column="PAYEE_ACC_NO"   jdbcType="VARCHAR" property="payeeAccNo"/>
        <result column="REMARKS"        jdbcType="VARCHAR" property="remarks"/>
        <result column="FILE_BATCH_NO"  jdbcType="BIGINT" property="fileBatchNo"/>
        <result column="CREATE_AT"      jdbcType="TIMESTAMP" property="createAt"/>
        <result column="CREATE_BY"      jdbcType="VARCHAR" property="createBy"/>
        <result column="UPDATE_BY"      jdbcType="VARCHAR" property="updateBy"/>
        <result column="UPDATE_AT"      jdbcType="TIMESTAMP" property="updateAt"/>
    </resultMap>

    <!--查询返回信息-->
    <resultMap id="QueryBaseResultMap" type="com.baofu.international.global.account.core.dal.model.UserWithdrawOrderQueryDo" extends="BaseResultMap">
        <result column="COMMODITY_NAME" jdbcType="VARCHAR" property="commodityName"/>
        <result column="COMMODITY_AMOUNT" jdbcType="VARCHAR" property="commodityAmount"/>
        <result column="COMMODITY_PRICE" jdbcType="VARCHAR" property="commodityPrice"/>
    </resultMap>
    <sql id="Base_Column_List">
        T.ID,
        T.USER_NO,
        T.USER_TRANS_ID,
        T.ORDER_ID,
        T.TRADE_AT,
        T.ORDER_AMT,
        T.ORDER_CCY,
        T.PAYEE_ID_TYPE,
        T.PAYEE_ID_NO,
        T.PAYEE_NAME,
        T.PAYEE_ACC_NO,
        T.REMARKS,
        T.FILE_BATCH_NO,
        T.CREATE_AT,
        T.CREATE_BY,
        T.UPDATE_BY,
        T.UPDATE_AT
    </sql>
    <!-- 商户订单号校验 -->
    <select id="selectMerchantTrans" resultType="java.lang.String">
        SELECT
        USER_TRANS_ID
        FROM
        T_USER_WITHDRAW_ORDER T
        WHERE
        T.USER_NO = #{userNo}
        AND
        T.USER_TRANS_ID IN(
        <foreach collection="memberTransIds" item="memberTransId" index="key" separator=",">
            #{memberTransId}
        </foreach>
        )
    </select>

    <!-- 批量新增结汇订单信息 -->
    <insert id="batchInsert" parameterType="java.util.List">
        insert into T_USER_WITHDRAW_ORDER (
        USER_NO,
        USER_TRANS_ID,
        ORDER_ID,
        TRADE_AT,
        ORDER_AMT,
        ORDER_CCY,
        PAYEE_ID_TYPE,
        PAYEE_ID_NO,
        PAYEE_NAME,
        PAYEE_ACC_NO,
        CREATE_AT,
        CREATE_BY,
        UPDATE_BY,
        UPDATE_AT,
        FILE_BATCH_NO
        )
        values
        <foreach collection="list" item="item" index="index" separator=",">
            (
            #{item.userNo,jdbcType=BIGINT},
            #{item.userTransId,jdbcType=VARCHAR},
            #{item.orderId,jdbcType=BIGINT},
            #{item.tradeAt,jdbcType=TIMESTAMP},
            #{item.orderAmt,jdbcType=DECIMAL},
            #{item.orderCcy,jdbcType=CHAR},
            #{item.payeeIdType,jdbcType=INTEGER},
            #{item.payeeIdNo,jdbcType=VARCHAR},
            #{item.payeeName,jdbcType=VARCHAR},
            #{item.payeeAccNo,jdbcType=VARCHAR},
            NOW(),
            #{item.createBy,jdbcType=VARCHAR},
            #{item.updateBy,jdbcType=VARCHAR},
            NOW(),
            #{item.fileBatchNo,jdbcType=BIGINT}
            )
        </foreach>
    </insert>

    <!-- 根据提现订单明细编号查询订单明细信息 -->
    <select id="selectOrderByUserNoAndFileNo" resultMap="QueryBaseResultMap">
        SELECT
          <include refid="Base_Column_List"/>,
        GROUP_CONCAT(T1.COMMODITY_NAME SEPARATOR ';') AS COMMODITY_NAME,
        GROUP_CONCAT(T1.COMMODITY_AMOUNT  SEPARATOR ';') AS COMMODITY_AMOUNT,
        GROUP_CONCAT(T1.COMMODITY_PRICE  SEPARATOR ';') AS COMMODITY_PRICE
        FROM
          T_USER_WITHDRAW_ORDER T
          LEFT JOIN T_WITHDRAW_ORDER_ITEM T1 ON T.ORDER_ID = T1.ORDER_ID
        WHERE
          T.USER_NO = #{userNo}
        AND T.FILE_BATCH_NO = #{fileBatchNo,jdbcType=BIGINT}
        GROUP BY T.ORDER_ID
    </select>
</mapper>