<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baofu.international.global.account.core.dal.mapper.UserAccountApplyMapper">
    <resultMap id="BaseResultMap" type="com.baofu.international.global.account.core.dal.model.UserPayeeAccountApplyDo">
        <id column="ID" jdbcType="BIGINT" property="id"/>
        <result column="APPLY_ID" jdbcType="BIGINT" property="applyId"/>
        <result column="QUALIFIED_NO" jdbcType="BIGINT" property="qualifiedNo"/>
        <result column="STORE_NO" jdbcType="BIGINT" property="storeNo"/>
        <result column="APPLY_ACC_NO" jdbcType="VARCHAR" property="applyAccNo"/>
        <result column="USER_NO" jdbcType="BIGINT" property="userNo"/>
        <result column="CCY" jdbcType="CHAR" property="ccy"/>
        <result column="CHANNEL_ID" jdbcType="BIGINT" property="channelId"/>
        <result column="ACCOUNT_NO" jdbcType="BIGINT" property="accountNo"/>
        <result column="STATUS" jdbcType="TINYINT" property="status"/>
        <result column="REMARKS" jdbcType="VARCHAR" property="remarks"/>
        <result column="CREATE_AT" jdbcType="TIMESTAMP" property="createAt"/>
        <result column="CREATE_BY" jdbcType="VARCHAR" property="createBy"/>
        <result column="UPDATE_AT" jdbcType="TIMESTAMP" property="updateAt"/>
        <result column="UPDATE_BY" jdbcType="VARCHAR" property="updateBy"/>
    </resultMap>

    <!--用户申请开通收款账户列表查询-->
    <resultMap id="AccApplyQueryMap"
               type="com.baofu.international.global.account.core.dal.model.user.UserApplyAccQueryRespDo">
        <result column="APPLY_ID" jdbcType="BIGINT" property="applyId"/>
        <result column="USER_NO" jdbcType="BIGINT" property="userNo"/>
        <result column="NAME" jdbcType="VARCHAR" property="userName"/>
        <result column="CCY" jdbcType="CHAR" property="ccy"/>
        <result column="STORE_PLATFORM" jdbcType="VARCHAR" property="storePlatform"/>
        <result column="CHANNEL_ID" jdbcType="BIGINT" property="channelId"/>
        <result column="USER_TYPE" jdbcType="BIGINT" property="userType"/>
        <result column="REALNAME_STATUS" jdbcType="BIGINT" property="realnameStatus"/>
        <result column="STATUS" jdbcType="TINYINT" property="applyStatus"/>
        <result column="SELLER_ID" jdbcType="VARCHAR" property="sellerId"/>
        <result column="STORE_NAME" jdbcType="VARCHAR" property="storeName"/>
        <result column="AWS_ACCESS_KEY" jdbcType="VARCHAR" property="awsAccessKey"/>
        <result column="SECRET_KEY" jdbcType="VARCHAR" property="secretKey"/>
        <result column="CREATE_AT" jdbcType="TIMESTAMP" property="createAt"/>
        <result column="ID_DFS_ID" jdbcType="BIGINT" property="idDfsId"/>
        <result column="ORG_CODE_CERT_DFS_ID" jdbcType="BIGINT" property="orgCodeCertDfsId"/>
        <result column="LEGAL_ID_FRONT_DFS_ID" jdbcType="BIGINT" property="legalIdFrontDfsId"/>
        <result column="LEGAL_ID_REVERSE_DFS_ID" jdbcType="BIGINT" property="idReverseDfsId"/>
        <result column="TAX_REGISTRATION_CERT_DFS_ID" jdbcType="BIGINT" property="taxRegistrationCertDfsId"/>
    </resultMap>


    <sql id="Base_Column_List">
             ID,
            APPLY_ID,
            STORE_NO,
            QUALIFIED_NO,
            USER_NO,
            APPLY_ACC_NO,
            CCY,
            CHANNEL_ID,
            STATUS,
            ACCOUNT_NO,
            REMARKS,
            CREATE_AT,
            CREATE_BY,
            UPDATE_AT,
            UPDATE_BY
    </sql>

    <select id="selectByApplyId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        /**TUserPayeeAccountApplyMapper.selectByApplyId*/
        SELECT
        <include refid="Base_Column_List"/>
        FROM T_USER_PAYEE_ACCOUNT_APPLY
        WHERE APPLY_ID = #{applyId,jdbcType=BIGINT}
    </select>

    <select id="selectByQualifiedNo" parameterType="java.lang.Long" resultMap="BaseResultMap">
        /**TUserPayeeAccountApplyMapper.selectByApplyId*/
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        T_USER_PAYEE_ACCOUNT_APPLY
        WHERE
        QUALIFIED_NO = #{qualifiedNo,jdbcType=BIGINT}
        AND STATUS = 0
    </select>

    <!--根据店铺编号查询开户申请记录信息-->
    <select id="selectByStoreNo" parameterType="java.lang.Long" resultMap="BaseResultMap">
        /**TUserPayeeAccountApplyMapper.selectByStoreNo*/
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        T_USER_PAYEE_ACCOUNT_APPLY
        WHERE
        STORE_NO = #{storeNo,jdbcType=BIGINT}
    </select>

    <!--根据店铺编号查询开户申请记录信息-->
    <select id="selectByUserNo" parameterType="java.lang.Long" resultMap="BaseResultMap">
        /**TUserPayeeAccountApplyMapper.selectByStoreNo*/
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        T_USER_PAYEE_ACCOUNT_APPLY
        WHERE
        USER_NO = #{userNo,jdbcType=BIGINT}
        AND
        CCY=#{ccy,jdbcType=CHAR}
    </select>

    <select id="selectByApplyInfo"
            parameterType="com.baofu.international.global.account.core.dal.model.UserPayeeAccountApplyDo"
            resultMap="BaseResultMap">
        /**TUserPayeeAccountApplyMapper.selectByApplyAccNo*/
        SELECT
        <include refid="Base_Column_List"/>
        FROM T_USER_PAYEE_ACCOUNT_APPLY
        WHERE
        APPLY_ACC_NO = #{applyAccNo,jdbcType=VARCHAR}
        AND
        CCY=#{ccy,jdbcType=CHAR}
        AND
        CHANNEL_ID=#{channelId,jdbcType=BIGINT}
        AND
        QUALIFIED_NO=#{qualifiedNo,jdbcType=BIGINT}
        AND STATUS != 3
    </select>

    <update id="updateStatusByApplyId"
            parameterType="com.baofu.international.global.account.core.dal.model.UserPayeeAccountApplyDo">
        /**TUserPayeeAccountApplyMapper.updateStatusByApplyId*/
        UPDATE
        T_USER_PAYEE_ACCOUNT_APPLY
        SET
        <if test="accountNo!=null">
            ACCOUNT_NO = #{accountNo,jdbcType=BIGINT},
        </if>
        <if test="applyAccNo!=null and applyAccNo !=''">
            APPLY_ACC_NO = #{applyAccNo,jdbcType=VARCHAR},
        </if>
        STATUS=#{status,jdbcType=TINYINT},
        UPDATE_AT = NOW()
        WHERE
        APPLY_ID = #{applyId,jdbcType=BIGINT}
    </update>

    <insert id="insert" parameterType="com.baofu.international.global.account.core.dal.model.UserPayeeAccountApplyDo">
        /**TUserPayeeAccountApplyMapper.insert**/
        INSERT INTO T_USER_PAYEE_ACCOUNT_APPLY (
            ID,
            APPLY_ID,
            STORE_NO,
            QUALIFIED_NO,
            USER_NO,
            APPLY_ACC_NO,
            CCY,
            CHANNEL_ID,
            STATUS,
            REMARKS,
            CREATE_AT,
            CREATE_BY,
            UPDATE_AT,
            UPDATE_BY
        )VALUES (
            #{id,jdbcType=BIGINT},
            #{applyId,jdbcType=BIGINT},
            #{storeNo,jdbcType=BIGINT},
            #{qualifiedNo,jdbcType=BIGINT},
            #{userNo,jdbcType=BIGINT},
            #{applyAccNo,jdbcType=VARCHAR},
            #{ccy,jdbcType=CHAR},
            #{channelId,jdbcType=BIGINT},
            #{status,jdbcType=TINYINT},
            #{remarks,jdbcType=VARCHAR},
            NOW(),
            #{createBy,jdbcType=VARCHAR},
            NOW(),
            #{updateBy,jdbcType=VARCHAR}
        )
    </insert>

    <!--查询用户申请开通收款账户信息-->
    <select id="selectAccApplyList"
            parameterType="com.baofu.international.global.account.core.dal.model.user.UserApplyAccQueryReqDo"
            resultMap="AccApplyQueryMap">
        /**TUserPayeeAccountApplyMapper.selectAccApplyList*/
        SELECT
        t.APPLY_ID,
        t.USER_NO,
        t.NAME,
        t.CCY,
        t.STORE_PLATFORM,
        t.CHANNEL_ID,
        t.REALNAME_STATUS,
        t.STATUS,
        t.CREATE_AT,
        t.SELLER_ID,
        t.AWS_ACCESS_KEY,
        t.SECRET_KEY,
        t.ID_DFS_ID,
        t.ORG_CODE_CERT_DFS_ID,
        t.LEGAL_ID_FRONT_DFS_ID,
        t.USER_TYPE,
        t.LEGAL_ID_REVERSE_DFS_ID,
        t.STORE_NAME,
        t.TAX_REGISTRATION_CERT_DFS_ID
        FROM (
        SELECT
        APPLY.APPLY_ID,
        APPLY.USER_NO,
        ORG.NAME,
        APPLY.CCY,
        STORE.STORE_PLATFORM,
        APPLY.CHANNEL_ID,
        ORG.REALNAME_STATUS,
        APPLY.STATUS,
        APPLY.CREATE_AT,
        STORE.SELLER_ID,
        STORE.AWS_ACCESS_KEY,
        STORE.SECRET_KEY,
        ORG.ID_DFS_ID,
        ORG.ORG_CODE_CERT_DFS_ID,
        ORG.LEGAL_ID_FRONT_DFS_ID,
        ORG.LEGAL_ID_REVERSE_DFS_ID,
        ORG.TAX_REGISTRATION_CERT_DFS_ID,
        STORE.STORE_NAME,
        2 AS USER_TYPE
        FROM T_USER_PAYEE_ACCOUNT_APPLY APPLY
        INNER JOIN T_USER_STORE STORE ON APPLY.STORE_NO = STORE.STORE_NO
        INNER JOIN T_ACC_QUALIFIED QUALIFIED ON APPLY.QUALIFIED_NO = QUALIFIED.QUALIFIED_NO
        INNER JOIN T_USER_ORG ORG ON QUALIFIED.USER_INFO_NO = ORG.USER_INFO_NO
        UNION ALL
        SELECT
        APPLY.APPLY_ID,
        APPLY.USER_NO,
        PERSONAL.NAME,
        APPLY.CCY,
        STORE.STORE_PLATFORM,
        APPLY.CHANNEL_ID,
        PERSONAL.REALNAME_STATUS,
        APPLY.STATUS,
        APPLY.CREATE_AT,
        STORE.SELLER_ID,
        STORE.AWS_ACCESS_KEY,
        STORE.SECRET_KEY,
        0 AS ID_DFS_ID,
        0 AS ORG_CODE_CERT_DFS_ID,
        0 AS LEGAL_ID_FRONT_DFS_ID,
        0 AS LEGAL_ID_REVERSE_DFS_ID,
        0 AS TAX_REGISTRATION_CERT_DFS_ID,
        ''AS STORE_NAME,
        1 AS USER_TYPE
        FROM T_USER_PAYEE_ACCOUNT_APPLY APPLY
        INNER JOIN T_USER_STORE STORE ON APPLY.STORE_NO = STORE.STORE_NO
        INNER JOIN T_ACC_QUALIFIED QUALIFIED ON APPLY.QUALIFIED_NO = QUALIFIED.QUALIFIED_NO
        INNER JOIN T_USER_PERSONAL PERSONAL ON PERSONAL.USER_INFO_NO = QUALIFIED.USER_INFO_NO
        ) t
        WHERE 1 = 1
        <if test="userNo!=null and userNo!=''">
            AND t.USER_NO = #{userNo}
        </if>
        <if test="userName!=null and userName!=''">
            AND t.NAME = #{userName}
        </if>
        <if test="ccy!=null and ccy!=''">
            AND t.CCY = #{ccy}
        </if>
        <if test="storePlatform!=null and storePlatform!=''">
            AND t.STORE_PLATFORM = #{storePlatform}
        </if>
        <if test="channelId!=null and channelId!=''">
            AND t.CHANNEL_ID = #{channelId}
        </if>
        <if test="realnameStatus!=null and realnameStatus!=''">
            <if test="realnameStatus==4">
                AND t.REALNAME_STATUS = 0
            </if>
            <if test="realnameStatus!=4">
                AND t.REALNAME_STATUS = #{realnameStatus}
            </if>
        </if>
        <if test="begin!=null and begin!=''">
            AND t.CREATE_AT >= #{begin}
        </if>
        <if test="end!=null and end!=''">
            AND t.CREATE_AT &lt;= #{end}
        </if>
        ORDER BY t.CREATE_AT DESC
    </select>

    <!--查询用户申请条件-->
    <sql id="selectAccApplyCondition">
        WHERE 1=1
        <if test="userNo!=null">
            AND APPLY.USER_NO = #{userNo}
        </if>
        <if test="ccy!=null and ccy!=''">
            AND APPLY.CCY = #{ccy}
        </if>
        <if test="storePlatform!=null and storePlatform!=''">
            AND STORE.STORE_PLATFORM = #{storePlatform}
        </if>
        <if test="channelId!=null">
            AND APPLY.CHANNEL_ID = #{channelId}
        </if>
        <if test="beginTime!=null">
            AND APPLY.CREATE_AT >= #{beginTime}
        </if>
        <if test="endTime!=null">
            AND APPLY.CREATE_AT &lt;= #{endTime}
        </if>
    </sql>

    <!--查询用户申请币种信息-->
    <select id="selectAccApplyCcyByUserNo" resultType="java.lang.String">
    /**TUserPayeeAccountApplyMapper.selectAccApplyCcyByUserNo*/
    SELECT
      CCY
    FROM
      T_USER_PAYEE_ACCOUNT_APPLY
    WHERE
      USER_NO= #{userNo,jdbcType=BIGINT}
    GROUP BY CCY
    </select>
</mapper>