<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baofu.international.global.account.core.dal.mapper.UserWithdrawApplyMapper">
    <resultMap id="BaseResultMap" type="com.baofu.international.global.account.core.dal.model.UserWithdrawApplyDo">
        <id column="ID" jdbcType="BIGINT" property="id"/>
        <result column="WITHDRAW_ID" jdbcType="BIGINT" property="withdrawId"/>
        <result column="USER_NO" jdbcType="BIGINT" property="userNo"/>
        <result column="ACCOUNT_NO" jdbcType="BIGINT" property="accountNo"/>
        <result column="BANK_NAME" jdbcType="VARCHAR" property="bankName"/>
        <result column="BANK_CARD_HOLDER" jdbcType="VARCHAR" property="bankCardHolder"/>
        <result column="BANK_CARD_NO" jdbcType="VARCHAR" property="bankCardNo"/>
        <result column="WITHDRAW_AMT" jdbcType="DECIMAL" property="withdrawAmt"/>
        <result column="WITHDRAW_CCY" jdbcType="CHAR" property="withdrawCcy"/>
        <result column="WITHDRAW_FEE" jdbcType="DECIMAL" property="withdrawFee"/>
        <result column="DEST_AMT" jdbcType="DECIMAL" property="destAmt"/>
        <result column="DEST_CCY" jdbcType="CHAR" property="destCcy"/>
        <result column="TRANSFER_RATE" jdbcType="DECIMAL" property="transferRate"/>
        <result column="DEDUCT_AMT" jdbcType="DECIMAL" property="deductAmt"/>
        <result column="TRANSFER_STATE" jdbcType="TINYINT" property="transferState"/>
        <result column="WITHDRAW_STATE" jdbcType="TINYINT" property="withdrawState"/>
        <result column="SETTLE_FEE" jdbcType="DECIMAL" property="settleFee"/>
        <result column="WITHDRAW_AT" jdbcType="TIMESTAMP" property="withdrawAt"/>
        <result column="REMARKS" jdbcType="VARCHAR" property="remarks"/>
        <result column="CREATE_AT" jdbcType="TIMESTAMP" property="createAt"/>
        <result column="CREATE_BY" jdbcType="VARCHAR" property="createBy"/>
        <result column="UPDATE_AT" jdbcType="TIMESTAMP" property="updateAt"/>
        <result column="UPDATE_BY" jdbcType="VARCHAR" property="updateBy"/>
        <result column="WITHDRAW_FEE_RATE" jdbcType="DECIMAL" property="withdrawFeeRate"/>
        <result column="CHANNEL_ID" jdbcType="BIGINT" property="channelId"/>
    </resultMap>
    <sql id="Base_Column_List">
        ID, WITHDRAW_ID, USER_NO, ACCOUNT_NO, BANK_NAME, BANK_CARD_HOLDER, BANK_CARD_NO,
        WITHDRAW_AMT, WITHDRAW_CCY, WITHDRAW_FEE, DEST_AMT, DEST_CCY, TRANSFER_RATE, DEDUCT_AMT,
        TRANSFER_STATE, WITHDRAW_STATE, SETTLE_FEE, WITHDRAW_AT, REMARKS, CREATE_AT, CREATE_BY,
        UPDATE_AT, UPDATE_BY, WITHDRAW_FEE_RATE,
        CHANNEL_ID
    </sql>
    <!-- 根据平台流水号查询 -->
    <select id="selectByOrderId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        /*TUserWithdrawApplyMapper.selectByOrderId*/
        SELECT
        <include refid="Base_Column_List" />
        FROM T_USER_WITHDRAW_APPLY
        WHERE WITHDRAW_ID = #{withdrawId}
    </select>

    <!-- 插入数据 -->
    <insert id="insert" parameterType="com.baofu.international.global.account.core.dal.model.UserWithdrawApplyDo">
        /*TUserWithdrawApplyMapper.insert*/
        INSERT INTO T_USER_WITHDRAW_APPLY (
        WITHDRAW_ID,
        USER_NO,
        ACCOUNT_NO,
        BANK_NAME,
        BANK_CARD_HOLDER,
        BANK_CARD_NO,
        WITHDRAW_AMT,
        WITHDRAW_CCY,
        WITHDRAW_FEE,
        DEST_AMT,
        DEST_CCY,
        TRANSFER_RATE,
        DEDUCT_AMT,
        TRANSFER_STATE,
        WITHDRAW_STATE,
        REMARKS,
        CREATE_AT,
        CREATE_BY,
        UPDATE_AT,
        UPDATE_BY,
        WITHDRAW_FEE_RATE,
        CHANNEL_ID
        ) VALUES (
        #{withdrawId},
        #{userNo},
        #{accountNo},
        #{bankName},
        #{bankCardHolder},
        #{bankCardNo},
        #{withdrawAmt},
        #{withdrawCcy},
        #{withdrawFee},
        #{destAmt},
        #{destCcy},
        #{transferRate},
        #{deductAmt},
        #{transferState},
        #{withdrawState},
        #{remarks},
        NOW(),
        #{createBy},
        NOW(),
        #{updateBy},
        #{withdrawFeeRate},
        #{channelId,jdbcType=BIGINT}
        )
    </insert>

    <!-- 根据平台流水号修改 -->
    <update id="updateByOrderId" parameterType="com.baofu.international.global.account.core.dal.model.UserWithdrawApplyDo">
        /*TUserWithdrawApplyMapper.updateByOrderId*/
        UPDATE T_USER_WITHDRAW_APPLY
        <set>
            <if test="transferState != null ">
                TRANSFER_STATE = #{transferState,jdbcType=BIGINT},
            </if>
            <if test="remarks != null ">
                REMARKS = #{remarks,jdbcType=BIGINT},
            </if>
            UPDATE_AT = NOW()
        </set>
        WHERE WITHDRAW_ID = #{withdrawId,jdbcType=BIGINT}
    </update>

    <!-- 提现查询 -->
    <select id="withdrawalQuery" parameterType="com.baofu.international.global.account.core.dal.model.TradeQueryDo"
            resultType="com.baofu.international.global.account.core.dal.model.WithdrawalQueryDo">
        SELECT
        s.CREATE_AT AS applyTime, --  时间
        t.STORE_NAME AS storeName,-- 店铺名称
        account.BANK_ACC_NO AS bankCard,-- 收款账户
        s.WITHDRAW_AMT AS withdrawalMoney, -- 提现金额
        s.WITHDRAW_FEE AS withdrawalFee, -- 提现手续费
        s.TRANSFER_RATE AS tradeRate, -- 成交汇率
        s.DEST_AMT AS sucMoney, -- 到账金额
        s.WITHDRAW_AT AS finishTime, -- 完成时间
        s.WITHDRAW_STATE  AS state ,  -- 状态
        s.TRANSFER_STATE AS transferState
        FROM T_USER_WITHDRAW_APPLY s
        LEFT JOIN T_USER_PAYEE_ACCOUNT_APPLY apply ON s.ACCOUNT_NO = apply.ACCOUNT_NO
        LEFT JOIN T_USER_PAYEE_ACCOUNT account ON account.ACCOUNT_NO = s.ACCOUNT_NO
        LEFT JOIN T_USER_STORE t ON t.STORE_NO =apply.STORE_NO
        WHERE s.USER_NO = #{userNo,jdbcType=BIGINT}
        <if test="accountType != null and accountType !='' ">
            AND s.WITHDRAW_CCY = #{accountType,jdbcType=CHAR}
        </if>
        <if test="accountNo != null">
            AND s.ACCOUNT_NO = #{accountNo,jdbcType=BIGINT}
        </if>
        <if test="state != null and state !='' ">
            <if test="state == 1 ">
                AND s.WITHDRAW_STATE in (0,1)
            </if>
            <if test="state == 3 ">
                AND s.WITHDRAW_STATE = 3 or s.TRANSFER_STATE=3
            </if>
            <if test="state != 1 and state!=3">
                AND s.WITHDRAW_STATE = #{state,jdbcType=TINYINT}
            </if>
        </if>
        <if test="beginTime != null and beginTime !='' ">
            AND s.CREATE_AT >= #{beginTime,jdbcType=TIMESTAMP}
        </if>
        <if test="endTime != null and endTime !='' ">
            <![CDATA[
              AND s.CREATE_AT<= #{endTime,jdbcType=TIMESTAMP}
            ]]>
        </if>
        ORDER BY s.CREATE_AT DESC
    </select>

    <!--根据平台流水号批量修改用户提现申请的转账状态-->
    <update id="updateUserWithdrawApplyState">
        /**TUserWithdrawApplyMapper.updateUserWithdrawApplyState**/
        UPDATE
        T_USER_WITHDRAW_APPLY
        <set>
            WITHDRAW_STATE = #{withdrawState,jdbcType=INTEGER},
            UPDATE_AT = NOW()
        </set>
        WHERE
        WITHDRAW_ID IN (
        <foreach collection="orderIdList" item="orderId" separator=",">
            ${orderId}
        </foreach>
        )
    </update>

    <!--根据时间查询-->
    <select id="selectByTime" resultMap="BaseResultMap">
        /**TUserWithdrawApplyMapper.selectByTime**/
        SELECT
        <include refid="Base_Column_List" />
        FROM
        T_USER_WITHDRAW_APPLY
        WHERE
        CREATE_AT &gt;= DATE_SUB(NOW(), INTERVAL 2 DAY)
        AND
        CREATE_AT &lt; NOW()
        AND
        TRANSFER_STATE = 2
        AND
        WITHDRAW_STATE = 0
        AND
        CHANNEL_ID =#{channelId,jdbcType=BIGINT}
    </select>

    <!--根据汇总批次号查询所有明细文件批次号-->
    <select id="queryUserWithdrawByOrderId" parameterType="java.lang.Long" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List" />
        FROM T_USER_WITHDRAW_APPLY T2
        WHERE EXISTS
        ( SELECT 1 FROM T_USER_WITHDRAW_RELATION T1
        WHERE T1.WITHDRAW_ID = T2.WITHDRAW_ID
        AND T1.WITHDRAW_BATCH_ID =  #{orderId,jdbcType=INTEGER} )
    </select>

    <!-- 更新转账明细信息 -->
    <update id="modifyWithdrawApplyDo">
        UPDATE T_USER_WITHDRAW_APPLY
        <set>
            <if test="transferState != null">
                TRANSFER_STATE = #{transferState,jdbcType=TINYINT},
            </if>
            <if test="transferRate != null">
                TRANSFER_RATE = #{transferRate,jdbcType=DECIMAL},
            </if>
            <if test="destCcy != null">
                DEST_CCY = #{destCcy,jdbcType=CHAR},
            </if>
            <if test="destAmt != null">
                DEST_AMT = #{destAmt,jdbcType=DECIMAL},
            </if>
            <if test="withdrawFee != null">
                WITHDRAW_FEE = #{withdrawFee,jdbcType=DECIMAL},
            </if>
            <if test="withdrawState != null">
                WITHDRAW_STATE = #{withdrawState,jdbcType=TINYINT},
            </if>
            <if test="settleFee != null">
                SETTLE_FEE = #{settleFee,jdbcType=DECIMAL},
            </if>
            <if test="withdrawAt != null">
                WITHDRAW_AT = #{withdrawAt,jdbcType=TIMESTAMP},
            </if>
            <if test="remarks != null ">
                REMARKS = #{remarks,jdbcType=BIGINT},
            </if>
            UPDATE_AT = NOW()
        </set>
        WHERE WITHDRAW_ID = #{withdrawId,jdbcType=INTEGER}
    </update>

    <!--用户提现申请分页查询-->
    <select id="selectUserWithdrawApplyPageInfo" resultMap="BaseResultMap">
        /**TUserWithdrawApplyMapper.selectUserWithdrawApplyPageInfo**/
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        T_USER_WITHDRAW_APPLY
        <where>
            AND WITHDRAW_ID IN (
            <foreach collection="withdrawId" item="withdrawId" separator=",">
                ${withdrawId}
            </foreach>
            )
            <if test="applyDo.withdrawId != null">
                AND WITHDRAW_ID = #{applyDo.withdrawId,jdbcType=BIGINT}
            </if>
            <if test="applyDo.userNo != null">
                AND USER_NO = #{applyDo.userNo,jdbcType=BIGINT}
            </if>
            <if test="applyDo.withdrawState != null">
                AND WITHDRAW_STATE = #{applyDo.withdrawState,jdbcType=INTEGER}
            </if>
        </where>
        ORDER BY CREATE_AT DESC
    </select>


    <!-- 用户提现明细后台查询 -->
    <select id="selectUserWithdrawDetails" resultType="com.baofu.international.global.account.core.dal.model.UserWithdrawDetailsDo"
            parameterType="com.baofu.international.global.account.core.dal.model.WithdrawDetailsQueryDo">
        SELECT
        D.WITHDRAW_ID AS withdrawId,
        D.USER_NO AS userNo,
        D.WITHDRAW_AMT AS withdrawAmount,
        D.WITHDRAW_CCY AS withdrawCCY,
        D.WITHDRAW_FEE AS fee,
        D.WITHDRAW_FEE_RATE AS feeRate,
        D.TRANSFER_RATE AS rate,
        D.DEST_AMT AS settleAmount,
        D.WITHDRAW_STATE AS withdrawStatus,
        D.CREATE_AT AS applyTime,
        D.WITHDRAW_AT AS finishTime
        FROM
        CBCA.T_USER_WITHDRAW_APPLY D
        WHERE 1=1
        <if test="userNo != null and userNo !=''">
            AND D.`USER_NO` = #{userNo}
        </if>
        <if test="withdrawId != null and withdrawId !=''">
            AND D.`WITHDRAW_ID` = #{withdrawId}
        </if>
        <if test="ccy != null and ccy !=''">
            AND D.`WITHDRAW_CCY` = #{ccy}
        </if>
        <if test="endDate!=null">
            AND D.CREATE_AT &lt;= #{endDate}
        </if>
        <if test="startDate!=null">
            AND D.CREATE_AT &gt;= #{startDate}
        </if>
        <if test="withdrawStatus != null and withdrawStatus !=''">
            AND D.WITHDRAW_STATE = #{withdrawStatus}
        </if>
    </select>

    <!-- 渠道提现明细后台查询 -->
    <select id="selectChannelWithdrawDetails" resultType="com.baofu.international.global.account.core.dal.model.ChannelWithdrawDetailsDo"
            parameterType="com.baofu.international.global.account.core.dal.model.WithdrawDetailsQueryDo">
        SELECT
        D.WITHDRAW_ID AS withdrawId,
        D.USER_NO AS userNo,
        D.WITHDRAW_AMT AS withdrawAmount,
        D.WITHDRAW_CCY AS withdrawCCY,
        D.WITHDRAW_FEE AS feeRate,
        D.WITHDRAW_AMT*D.WITHDRAW_FEE AS fee,
        D.TRANSFER_RATE AS rate,
        D.DEST_AMT-D.SETTLE_FEE AS arriveAmount,
        D.WITHDRAW_STATE AS withdrawStatus,
        D.TRANSFER_STATE AS transferStatus,
        D.CREATE_AT AS applyTime,
        D.WITHDRAW_AT AS finishTime,
        SU.WITHDRAW_BATCH_ID AS batchNo,
        SU.CHANNEL_NAME AS channel
        FROM
        CBCA.T_USER_WITHDRAW_APPLY D
        LEFT JOIN
        CBCA.T_USER_WITHDRAW_RELATION REL
        ON D.WITHDRAW_ID = REL.WITHDRAW_ID
        LEFT JOIN
        CBCA.T_USER_WITHDRAW_SUM SU
        ON SU.WITHDRAW_BATCH_ID = REL.WITHDRAW_BATCH_ID
        WHERE 1=1
        <if test="userNo != null and userNo !=''">
            AND D.`USER_NO` = #{userNo}
        </if>
        <if test="withdrawId != null and withdrawId !=''">
            AND D.`WITHDRAW_ID` = #{withdrawId}
        </if>
        <if test="ccy != null and ccy !=''">
            AND D.`WITHDRAW_CCY` = #{ccy}
        </if>
        <if test="endDate!=null">
            AND D.CREATE_AT &lt;= #{endDate}
        </if>
        <if test="startDate!=null">
            AND D.CREATE_AT &gt;= #{startDate}
        </if>
        <if test="withdrawStatus != null and withdrawStatus !=''">
            AND D.WITHDRAW_STATE = #{withdrawStatus}
        </if>
        <if test="transferStatus != null and transferStatus !=''">
            AND D.TRANSFER_STATE = #{transferStatus}
        </if>
        <if test="channel != null and channel !=''">
            AND SU.CHANNEL_NAME = #{channel}
        </if>
    </select>
</mapper>
