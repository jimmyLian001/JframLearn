<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.baofu.international.global.account.core.dal.mapper.PaymentDetailMapper">
    <resultMap id="BaseResultMap" type="com.baofu.international.global.account.core.dal.model.PaymentDetailDo">
        <id column="ID"                     jdbcType="BIGINT"       property="id"/>
        <result column="DETAIL_ID"          jdbcType="BIGINT"       property="detailId"/>
        <result column="USER_NO"            jdbcType="BIGINT"       property="userNo"/>
        <result column="WALLET_ID"          jdbcType="VARCHAR"      property="walletId"/>
        <result column="BANK_RESP_ID"       jdbcType="VARCHAR"      property="bankRespId"/>
        <result column="ORDER_AMT"          jdbcType="DECIMAL"      property="orderAmt"/>
        <result column="ORDER_CCY"          jdbcType="CHAR"         property="orderCcy"/>
        <result column="BUSINESS_TYPE"      jdbcType="TINYINT"      property="businessType"/>
        <result column="BALANCE_DIRECTION"  jdbcType="TINYINT"      property="balanceDirection"/>
        <result column="REMARKS"            jdbcType="VARCHAR"      property="remarks"/>
        <result column="CREATE_AT"          jdbcType="TIMESTAMP"    property="createAt"/>
        <result column="CREATE_BY"          jdbcType="VARCHAR"      property="createBy"/>
        <result column="UPDATE_AT"          jdbcType="TIMESTAMP"    property="updateAt"/>
        <result column="UPDATE_BY"          jdbcType="VARCHAR"      property="updateBy"/>
    </resultMap>
    <sql id="Base_Column_List">
        ID, DETAIL_ID, USER_NO, WALLET_ID, BANK_RESP_ID, ORDER_AMT, ORDER_CCY, BUSINESS_TYPE,
        BALANCE_DIRECTION, REMARKS, CREATE_AT, CREATE_BY, UPDATE_AT, UPDATE_BY
    </sql>
    <!-- 查询交易信息-->
    <select id="tradeAccQuery" parameterType="com.baofu.international.global.account.core.dal.model.TradeQueryDo"
            resultType="com.baofu.international.global.account.core.dal.model.TradeAccQueryDo">
        SELECT
        s.CREATE_AT AS tradeTime ,
        CONCAT(p.BANK_ACC_NO,' - ',tus.STORE_NAME) AS accountNumber,
        (
        CASE s.BALANCE_DIRECTION
        WHEN 1 THEN
        (CASE s.ORDER_CCY
        WHEN 'USD' THEN CONCAT('$',s.ORDER_AMT)
        WHEN 'JPY' THEN CONCAT('¥',s.ORDER_AMT)
        WHEN 'EUR' THEN CONCAT('€',s.ORDER_AMT)
        WHEN 'GBP' THEN CONCAT('￡',s.ORDER_AMT)
        ELSE s.ORDER_AMT END
        )
        ELSE '/' END
        ) AS tradeInAccMoney,
        (
        CASE s.BALANCE_DIRECTION
        WHEN 2 THEN
        (CASE s.ORDER_CCY
        WHEN 'USD' THEN CONCAT('$',s.ORDER_AMT)
        WHEN 'JPY' THEN CONCAT('¥',s.ORDER_AMT)
        WHEN 'EUR' THEN CONCAT('€',s.ORDER_AMT)
        WHEN 'GBP' THEN CONCAT('￡',s.ORDER_AMT)
        ELSE s.ORDER_AMT END
        )
        ELSE '/' END
        ) AS tradeOutAccMoney,
        s.REMARKS AS remark
        FROM T_PAYMENT_DETAIL s
        LEFT JOIN T_USER_PAYEE_ACCOUNT p ON s.ACCOUNT_NO = p.ACCOUNT_NO
        LEFT JOIN T_USER_PAYEE_ACCOUNT_APPLY apply ON apply.ACCOUNT_NO = s.ACCOUNT_NO
        LEFT JOIN T_USER_STORE tus ON apply.STORE_NO=tus.STORE_NO
        WHERE
          s.USER_NO = #{userNo,jdbcType=BIGINT}
        <if test="accountNo !=null and accountNo!=''">
            AND p.ACCOUNT_NO = #{accountNo,jdbcType=BIGINT}
        </if>
        <if test="accountType !=null and accountType!=''">
            AND s.ORDER_CCY = #{accountType,jdbcType=VARCHAR}
        </if>
        <if test="flag !=null and flag!=''">
            AND s.BALANCE_DIRECTION = #{flag,jdbcType=TINYINT}
        </if>
        <if test="beginTime !=null and beginTime!=''">
            AND s.CREATE_AT >= #{beginTime,jdbcType=TIMESTAMP}
        </if>
        <if test="endTime !=null and endTime!=''">
            <![CDATA[
                AND s.CREATE_AT <= #{endTime,jdbcType=TIMESTAMP}
            ]]>
        </if>
        ORDER BY s.CREATE_AT DESC
    </select>

    <!--查询收支明细信息-->
    <select id="selectPaymentDetail" parameterType="com.baofu.international.global.account.core.dal.model.PaymentDetailDo"
            resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM
        T_PAYMENT_DETAIL
        WHERE
        USER_NO = #{userNo,jdbcType=BIGINT}
        AND
        BANK_RESP_ID = #{bankRespId,jdbcType=VARCHAR}
    </select>


    <!-- 子账户收支明细查询-->
    <select id="subAccTradeDetailQuery" resultType="com.baofu.international.global.account.core.dal.model.SubAccTradeDetailDo"
            parameterType="com.baofu.international.global.account.core.dal.model.SubAccTradeDetailQueryReqDo">
        SELECT s.DETAIL_ID AS tradeId, -- 交易ID
        s.USER_NO AS userNo, -- 用户号
        IFNULL(a.BANK_ACC_NO,'') AS bankAccNo, -- 海外银行账户
        s.CREATE_AT AS tradeTime, -- 交易时间
        s.ORDER_CCY AS ccy, -- 币种
        (
        CASE s.BALANCE_DIRECTION
        WHEN 1 THEN s.ORDER_AMT
        ELSE ''
        END
        ) AS tradeInAccMoney, -- 收入
        (
        CASE s.BALANCE_DIRECTION
        WHEN 2 THEN s.ORDER_AMT
        ELSE ''
        END
        ) AS tradeOutAccMoney ,-- 支出
        n.USER_TYPE AS userType, -- 商户类型
        l.NAME AS userName -- 商户名称
        FROM  CBCA.T_PAYMENT_DETAIL s
        LEFT JOIN CBCA.T_USER_PAYEE_ACCOUNT a ON s.ACCOUNT_NO=a.ACCOUNT_NO -- 主要是为了关联出海外银行账号
        LEFT JOIN CBCA.T_USER_INFO n ON s.USER_NO=n.USER_NO
        LEFT JOIN
        (
        SELECT u.USER_NO,p.NAME FROM CBCA.T_USER_INFO u  -- 主要是为了关联出用户名
        LEFT JOIN CBCA.T_USER_PERSONAL p ON u.USER_INFO_NO=p.USER_INFO_NO WHERE u.USER_TYPE = 1
        UNION
        SELECT a.USER_NO,q.NAME FROM CBCA.T_USER_INFO a
        LEFT JOIN CBCA.T_USER_ORG q ON a.USER_INFO_NO=q.USER_INFO_NO WHERE a.USER_TYPE = 2
        ) l ON s.USER_NO=l.USER_NO
        WHERE 1=1
        <if test='userType != null and userType != ""'>
            AND n.USER_TYPE = #{userType}
        </if>
        <if test='userNo != null and userNo != ""'>
            AND s.USER_NO = #{userNo}
        </if>
        <if test='ccy != null and ccy != ""'>
            AND s.ORDER_CCY = #{ccy}
        </if>
        <if test='beginTime != null and beginTime != ""'>
            AND s.CREATE_AT >= #{beginTime}
        </if>
        <if test='endTime != null and endTime != ""'>
            <![CDATA[
                      AND s.CREATE_AT <= #{endTime,jdbcType=TIMESTAMP}
                ]]>
        </if>
        <if test='bankAccNo != null and bankAccNo != ""'>
            AND sa.BANK_ACC_NO = #{bankAccNo}
        </if>
        ORDER BY s.CREATE_AT DESC
    </select>

    <!--新增收款账户收支明细-->
    <insert id="insertPaymentDetail" parameterType="com.baofu.international.global.account.core.dal.model.PaymentDetailDo">
        INSERT INTO T_PAYMENT_DETAIL (
        DETAIL_ID,
        USER_NO,
        WALLET_ID,
        BANK_RESP_ID,
        ORDER_AMT,
        ORDER_CCY,
        BUSINESS_TYPE,
        BALANCE_DIRECTION,
        REMARKS,
        CREATE_AT,
        CREATE_BY,
        UPDATE_AT,
        UPDATE_BY,
        ACCOUNT_NO
        )VALUES (
        #{detailId,jdbcType=BIGINT},
        #{userNo,jdbcType=BIGINT},
        #{walletId,jdbcType=VARCHAR},
        #{bankRespId,jdbcType=VARCHAR},
        #{orderAmt,jdbcType=DECIMAL},
        #{orderCcy,jdbcType=VARCHAR},
        #{businessType,jdbcType=INTEGER},
        #{balanceDirection,jdbcType=INTEGER},
        #{remarks,jdbcType=VARCHAR},
        NOW(),
        #{createBy,jdbcType=VARCHAR},
        NOW(),
        #{updateBy,jdbcType=VARCHAR},
        #{accountNo,jdbcType=BIGINT}
        )
    </insert>
</mapper>